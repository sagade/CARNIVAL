## Solving CARNIVAL problem for one single experimental condition
##
## Enio Gjerga, 2020

solveCARNIVALSingle <- function(data = data, pknList = pknList,
                                inputs = inputs, alphaWeight = alphaWeight,
                                betaWeight = betaWeight, scores = scores,
                                mipGAP = mipGAP, poolrelGAP = poolrelGAP,
                                limitPop = limitPop, poolCap = poolCap,
                                poolIntensity = poolIntensity,
                                poolReplace = poolReplace,
                                timelimit = timelimit,
                                threads = threads,
                                seed = seed,
                                measWeights = measWeights, repIndex = repIndex,
                                condition = condition, solver = solver,
                                solverPath = solverPath, variables = variables,
                                measObj = measObj, inputObj = inputObj,
                                dir_name = dir_name){

    variables <- writeLPFile(data = data, pknList = pknList,
                           inputs = inputs, alphaWeight = alphaWeight,
                           betaWeight = betaWeight, scores = scores,
                           mipGAP = mipGAP, poolrelGAP = poolrelGAP,
                           limitPop = limitPop, poolCap = poolCap,
                           poolIntensity = poolIntensity,
                           threads = threads,
                           poolReplace = poolReplace, timelimit = timelimit,
                           measWeights = measWeights, repIndex = repIndex,
                           condition = condition)

    ## Solve ILP problem with cplex, remove temp files,
    ## and return to the main directory
    message("Solving LP problem...")

    if(solver=="cplex"){

        # create temp file for logs
        cplex_log <- tempfile(pattern = "cplex_log_",
                              tmpdir = tempdir(check = TRUE),
                              fileext = ".txt")

        if (Sys.info()[1] == "Windows") {
            # TODO: implement logging on Win machine.
            file.copy(from = solverPath,to = getwd())
            system(paste0("cplex.exe -f cplexCommand_", condition,"_",repIndex,".txt"))
            file.remove("cplex.exe")
        } else {
            system(paste0(solverPath, " -f cplexCommand_",
                        condition,"_",repIndex,".txt",
                        " | tee ", cplex_log)) # send output to logfile and stdout
        }

        ## Write result files in the results folder
        message("Saving results...")
        resList <- list()
        if (file.exists(paste0("results_cplex_",condition,"_",repIndex,".txt"))) {
            for(i in seq_len(length(variables))){
                res <- exportResult(cplexSolutionFileName = paste0("results_cplex_",
                                                                   condition,"_",
                                                                   repIndex,".txt"),
                                    variables = variables,
                                    pknList = pknList,
                                    conditionIDX = i,
                                    inputs=inputObj,
                                    measurements=measObj)
                resList[[length(resList)+1]] <- res
            }
        }

        ## Remove global variable
        objs <- ls(pos = ".GlobalEnv")
        rm(list = objs[grep("pknList", objs)], pos = ".GlobalEnv")

        res = resList[[1]]

        # add log to results
        if(file.exists(cplex_log)){
            cplex_out <- parse_CPLEX_log(cplex_log)
            res$diagnostics = cplex_out
        }else{
            res$diagnostics = list()
        }

    } else if (solver=="cbc"){

        resFile = paste0("results_cbc_", 1, "_", 1, ".txt")

        cbc_command <- paste0(solverPath, " testFile_", 1, "_", 1, ".lp -seconds ", timelimit,
                              " -ratio ", poolrelGAP, " solve printi csv solu ", resFile)

        system(cbc_command)

        res <- exportResult(cplexSolutionFileName = resFile,
                            variables = variables,
                            conditionIDX = 1,
                            pknList = pknList,
                            inputs=inputObj,
                            measurements=measObj,
                            solver = "cbc")

    } else if (solver=="gurobi") {
        resFile = paste0("results_gurobi_", 1, "_", 1, ".sol")

        # no equivalants for poolIntensity, poolReplace parameters in gurobi
        gurobi_command <- paste0(solverPath,
                                 " TimeLimit=", timelimit,
                                 " MIPGAP=", mipGAP,
                                 " PoolGap=", poolrelGAP,
                                 " SolutionLimit=", limitPop,
                                 " PoolSearchMode=2",
                                 " PoolSolutions=", poolCap,
                                 " Threads=", threads,
                                 " Seed=", seed,
                                 " ResultFile=", resFile,
                                 " testFile_", 1, "_", 1, ".lp ")

        system(gurobi_command)

        res <- exportResult(cplexSolutionFileName = resFile,
                            variables = variables,
                            conditionIDX = 1,
                            pknList = pknList,
                            inputs=inputObj,
                            measurements=measObj,
                            solver = "gurobi")

    } else {

        lpForm <- prepareLPMatrixSingle(variables = variables, measObj = measObj)

        lpSolution <- lp(direction = "min", objective.in = lpForm$obj,
                       const.mat = lpForm$con, const.dir = lpForm$dir,
                       const.rhs = lpForm$rhs, int.vec = lpForm$ints,
                       binary.vec = lpForm$bins)$solution

        res <- exportResult(cplexSolutionFileName = NULL, variables = variables,
                          pknList = pknList, inputs = inputObj,
                          measurements = measObj, solver = solver,
                          lpSolution = lpSolution, mt = lpForm$mt,
                          conditionIDX = 1)
    }

    cleanupCARNIVAL(condition = condition, repIndex = repIndex)

    if (!is.null(res)) {
        if(!is.null(dir_name)){
            if(dir.exists(dir_name)){
                WriteDOTfig(res=res,
                            dir_name=dir_name,
                            inputs=inputObj,
                            measurements=measObj,
                            UP2GS=FALSE)
            } else {
                warning("Specified directory does not exist. DOT figure not saved.")
            }
        }
    } else {
        message("No result to be written")
        return(NULL)
    }

    message(" ")
    message("--- End of the CARNIVAL pipeline ---")
    message(" ")

    return(res)

}
